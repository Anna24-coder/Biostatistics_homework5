---
title: "Shutkevich_HW5"
output: html_document
date: "2024-04-09"
---

# Домашнее задание 5

Тема: построение регрессионных моделей и анализ выживаемости.

## Описание ДЗ

Для выполнения первых двух заданий загрузите датасет [Breast Cancer Wisconsin](https://lms.skillfactory.ru/asset-v1:SkillFactory+MFTIBIO+SEP2023+type@asset+block@wisconsin_breast_cancer.csv)

```{r}
# Загрузка необходимых пакетов
library(ggplot2)
library(tidyverse)
library(survival)
```

```{r}
# Загрузка файла и изучение типов данных датасета
data <- read.csv("wisconsin_breast_cancer.csv", header = TRUE)

head(data)
str(data)
```

В колонке diagnosis содержится информация об опухоли (M = злокачественная, B = доброкачественная).

## Задача 1

Создайте регрессионную модель, которая бы описывала связь среднего радиуса опухоли и средней площади (а), среднего периметра (б), средней симметричности (в).

Постройте графики, на которых отразите регрессионную прямую, и прокомментируйте свои находки.

```{r}
# Создание линейной регрессионной модели
model_a <- lm(area_mean ~ radius_mean, data = data)
model_b <- lm(perimeter_mean ~ radius_mean, data = data)
model_c <- lm(symmetry_mean ~ radius_mean, data = data)

# Построение графиков с регрессионными прямыми
ggplot(data, aes(x = radius_mean, y = area_mean)) +
  geom_point() +
  geom_smooth(method = "lm", col = "blue") +
  labs(title = "Зависимость средней площади от среднего радиуса")

ggplot(data, aes(x = radius_mean, y = perimeter_mean)) +
  geom_point() +
  geom_smooth(method = "lm", col = "blue") +
  labs(title = "Зависимость среднего периметра от среднего радиуса")

ggplot(data, aes(x = radius_mean, y = symmetry_mean)) +
  geom_point() +
  geom_smooth(method = "lm", col = "blue") +
  labs(title = "Зависимость средней симметричности от среднего радиуса")

# Комментарии к результатам
summary(model_a)
summary(model_b)
summary(model_c)

```

На основе полученных результатов линейной регрессии для каждой из трех моделей, можно сделать следующие выводы:

**Модель а:** Зависимость средней площади от среднего радиуса

Модель показывает, что с увеличением среднего радиуса опухоли на одну единицу, средняя площадь увеличивается примерно на 98.6 единиц.

Коэффициент при радиусе и свободный член (intercept) являются статистически значимыми (p-value \< 0.001), что указывает на сильную связь между радиусом и площадью опухоли.

Значение R-squared равно 0.9749, что означает, что модель объясняет около 97.49% вариативности средней площади опухоли. Это указывает на очень хорошее соответствие модели.

**Модель б:** Зависимость среднего периметра от среднего радиуса

С увеличением среднего радиуса опухоли на одну единицу, средний периметр увеличивается примерно на 6.88 единиц.

Как и в предыдущей модели, коэффициенты являются статистически значимыми (p-value \< 0.001).

Значение R-squared равно 0.9957, что означает, что модель объясняет около 99.57% вариативности среднего периметра опухоли. Это указывает на высокую точность модели.

**Модель в:** Зависимость средней симметричности от среднего радиуса

С увеличением среднего радиуса опухоли на одну единицу, средняя симметричность увеличивается примерно на 0.00115 единиц.

Коэффициент при радиусе и свободный член являются статистически значимыми (p-value \< 0.001 и p-value \< 0.05 соответственно), что указывает на наличие связи между радиусом и симметричностью, хотя эта связь и не так сильна, как в предыдущих моделях.

Значение R-squared равно 0.02183, что означает, что модель объясняет только около 2.18% вариативности средней симметричности опухоли. Это указывает на слабую связь между радиусом и симметричностью в данных.

**Общие выводы**

Существует сильная положительная связь между средним радиусом опухоли и ее средней площадью, а также средним периметром. Это ожидаемо, поскольку площадь и периметр геометрически связаны с радиусом.

Связь между средним радиусом и средней симметричностью опухоли также положительная, но крайне слабая. Это может указывать на то, что симметричность опухоли определяется другими факторами, помимо ее размера.

## Задача 2

Пусть колонка с диагнозом принимает следующие значения: злокачественная опухоль — 1, а доброкачественная — 0. Постройте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от среднего радиуса (а), средней площади (б), средней текстуры (в).

Постройте графики. Создайте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от всех трех перечисленных факторов.

```{r}
# Преобразование колонки с диагнозом в числовой формат
data$diagnosis <- ifelse(data$diagnosis == "M", 1, 0)

# проверка
head(select(data, diagnosis),10)
```

```{r}
# Создание логистической регрессионной модели
logit_model <- glm(diagnosis ~ radius_mean + area_mean + texture_mean, data = data, family = "binomial")

# Построение графиков
# Для логистической регрессии графики могут быть более сложными, так как зависимость нелинейная.
# Однако мы можем визуализировать вероятности, предсказанные моделью, на графике с наблюдаемыми значениями.

# Получение предсказанных вероятностей
data$predicted_prob <- predict(logit_model, type = "response")

# График для среднего радиуса
ggplot(data, aes(x = radius_mean, y = predicted_prob)) +
  geom_point(aes(color = as.factor(diagnosis)), alpha = 0.5) +
  labs(title = "Предсказание вероятности злокачественной опухоли от среднего радиуса")

# График для средней площади
ggplot(data, aes(x = area_mean, y = predicted_prob)) +
  geom_point(aes(color = as.factor(diagnosis)), alpha = 0.5) +
  labs(title = "Предсказание вероятности злокачественной опухоли от средней площади")

# График для средней текстуры
ggplot(data, aes(x = texture_mean, y = predicted_prob)) +
  geom_point(aes(color = as.factor(diagnosis)), alpha = 0.5) +
  labs(title = "Предсказание вероятности злокачественной опухоли от средней текстуры")

# Комментарии к результатам
summary(logit_model)

```

По моделям хотелось бы добавить следующие комментарии:

**Коэффициенты (Coefficients):** Это оценки логарифмов шансов (log-odds) для каждого предиктора. Значения коэффициентов показывают величину влияния каждого предиктора на логарифм шансов того, что опухоль будет злокачественной.

**(Intercept):** Значение -9.48796 для перехвата (intercept) указывает на логарифм шансов злокачественной опухоли при всех предикторах, равных нулю.

**radius_mean:** Коэффициент для среднего радиуса равен -0.38523, но его p-значение (0.687) говорит о том, что этот предиктор не является статистически значимым на обычных уровнях значимости (например, 0.05).

**area_mean:** Коэффициент для средней площади равен 0.01636, и его p-значение (0.137) также указывает на отсутствие статистической значимости.

**texture_mean:** Коэффициент для средней текстуры равен 0.20917, и он статистически значим с p-значением 1.78e-08 (что намного меньше 0.05). Это означает, что средняя текстура является значимым предиктором злокачественности опухоли.

**Signif. codes:** Звездочки рядом с p-значениями указывают на уровень статистической значимости. В данном случае, только texture_mean имеет три звездочки, что указывает на очень высокую статистическую значимость.

**Null deviance и Residual deviance:** Эти значения показывают, насколько хорошо модель соответствует данным по сравнению с нулевой моделью, которая предсказывает только среднее значение. Чем меньше остаточная девиация (Residual deviance) по сравнению с нулевой девиацией (Null deviance), тем лучше модель объясняет данные.

**AIC (Akaike Information Criterion):** Значение AIC помогает сравнивать модели - меньшее значение AIC указывает на более предпочтительную модель с точки зрения соотношения информативности и сложности.

**Number of Fisher Scoring iterations:** Количество итераций, необходимых для сходимости алгоритма оценки параметров модели. В данном случае модель сошлась за 7 итераций.

Исходя из этих результатов, можно сделать **вывод**, что средняя текстура является важным предиктором злокачественности опухоли, в то время как средний радиус и средняя площадь не имеют статистически значимого влияния в данной модели.

## Задача 3

Для выполнения задания понадобится датасет lung, который встроен в пакет survival. Установите этот пакет и загрузите датасет. Датасет содержит следующий набор переменных: inst: код учреждения; time: время выживаемости в днях; status: 1 = цензурирование, 2 = смерть; age: возраст в годах; sex: мужской = 1, женский = 2; ph.ecog: шкала опросника ECOG (оценку проводит врач). 0 = отсутствие симптомов, 1= симптомы есть, но пациент наблюдается амбулаторно, 2 = меньше половины дня пациент вынужден проводить в постели, 3 = больше половины дня нуждается в отдыхе лежа, но не прикован к постели, 4 = прикован к постели; ph.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке врача; pat.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке пациента; meal.cal: калории потребляемой пищи; wt.loss: потеря веса за последние полгода. Создайте переменную event, в которой отразите наличие или отсутствие (1 или 0) интересующего события — смерти пациента.

Изучите работу функций Surv(), survfit() и ggsurvplot():

Постройте кривые выживаемости в зависимости от пола (на одном графике должны получиться две кривые для каждого пола и таблица числа пациентов, подверженных риску (at risk) под ним). Поясните получившееся значение p-value для лог-рангового теста и опишите наблюдаемые результаты. Постройте график кумулятивной функции рисков (cumulative hazard function) для пола. Проинтерпретируйте график. С помощью функции coxph() постройте регрессию Кокса и оцените влияние пола на выживаемость. Что вы можете сказать о полученных результатах?

```{r}
# Установка и загрузка необходимых пакетов

library(survival)
#install.packages("survminer")
library(survminer)

# Загрузка данных
lung
```

```{r}
# Создание переменной event
lung$event <- ifelse(lung$status == 2, 1, 0)
```

Посмотрим, как функции Surv(), survfit() и ggsurvplot() используются в анализе выживаемости, какие аргументы они принимают и какие результаты они возвращают.

**Функция Surv()** из пакета survival используется для создания объекта выживаемости, который является основой для всех анализов выживаемости в R. Этот объект содержит информацию о времени до наступления интересующего события (например, время до смерти) и о том, произошло ли событие (например, смерть) или данные были цензурированы (то есть наблюдение закончилось до наступления события). Функция Surv() не создает визуализацию напрямую, а используется для создания объекта выживаемости, который затем используется другими функциями для анализа и визуализации.

Пример использования:

```{r}
# Создание объекта выживаемости
surv_object <- Surv(time = lung$time, event = lung$status == 2)

```

**Функция survfit()** используется для подгонки кривых выживаемости по данным, созданным с помощью Surv(). Эта функция позволяет оценить вероятность выживания в разные моменты времени и может быть использована для группировки данных по различным категориям (например, по полу или возрасту). Результаты могут быть визуализированы с помощью базовых функций построения графиков в R или с помощью plot().

Пример использования:

```{r}
# Подгонка модели выживаемости
fit <- survfit(surv_object ~ sex, data = lung)

# Определение цветов и стилей линий для графика
colors <- c("blue", "red")
linetypes <- c(1, 2) # 1 - сплошная линия, 2 - пунктирная линия

# Построение графика
plot(fit, col = colors, lty = linetypes, lwd = 2, 
     main = "Кривые выживаемости по полу", xlab = "Время в днях", ylab = "Вероятность выживания",
     xlim = c(0, max(lung$time)), mark.time = TRUE)

# Добавление легенды с указанием цвета и стиля линии
legend("bottomleft", legend = c("Мужчины", "Женщины"), col = colors, lty = linetypes, lwd = 2)

```

**Функция ggsurvplot()** из пакета survminer используется для визуализации кривых выживаемости, полученных с помощью survfit(). Она предоставляет удобный способ создания красивых и информативных графиков кривых выживаемости с использованием грамматики ggplot2.

Пример использования:

```{r}
# Визуализация кривых выживаемости с помощью ggsurvplot
ggsurvplot(fit, data = lung, risk.table = TRUE, pval = TRUE,
           ggtheme = theme_minimal(),
           title = "Кривые выживаемости по полу",
           xlab = "Время в днях", ylab = "Вероятность выживания",
           palette = c("#2E9FDF", "#E79FDF"),
           legend.title = "Пол",
           legend.labs = c("Мужчины", "Женщины"))

```

```{r}
# Преобразование переменной sex в фактор с понятными метками
lung$sex <- factor(lung$sex, levels = c(1, 2), labels = c("Мужчины", "Женщины"))

# Построение кривых выживаемости
surv_object <- Surv(time = lung$time, event = lung$event)
fit <- survfit(surv_object ~ sex, data = lung)
ggsurvplot(fit, data = lung, risk.table = TRUE, pval = TRUE,
           palette = c("#2E9FDF", "#E79FDF"),
           legend.title = "Пол",
           legend.labs = c("Мужчины", "Женщины"))

# Построение графика кумулятивной функции рисков
ggsurvplot(fit, data = lung, fun = "cumhaz", risk.table = TRUE,
           palette = c("#2E9FDF", "#E79FDF"),
           legend.title = "Пол",
           legend.labs = c("Мужчины", "Женщины"))

# Построение регрессии Кокса
cox_model <- coxph(surv_object ~ sex, data = lung)
summary(cox_model)

```

Формула модели surv_object \~ sex указывает, что мы оцениваем влияние пола (sex) на выживаемость (surv_object). В анализе использовалось 228 наблюдений, из которых 165 закончились событием (в данном случае смертью).

**Результаты таблицы коэффициентов:**

**coef:** Коэффициент для переменной sex Женщины равен -0.5310. Это логарифм отношения рисков (log hazard ratio), который показывает, насколько изменяется риск события (в данном случае смерти) для женщин по сравнению с мужчинами (базовая категория).

**exp(coef):** Экспоненцированный коэффициент (hazard ratio) равен 0.5880. Это означает, что риск смерти для женщин на 41.2% ниже, чем для мужчин.

**se(coef):** Стандартная ошибка коэффициента равна 0.1672. z: Z-статистика для теста коэффициента равна -3.176. Pr(\>\|z\|): P-значение для теста коэффициента равно 0.00149. Так как это значение меньше стандартного порога значимости 0.05, мы можем сказать, что пол имеет статистически значимое влияние на выживаемость.

**Доверительный интервал для exp(coef):** lower .95 и upper .95: 95% доверительный интервал для hazard ratio находится между 0.4237 и 0.816. Это означает, что с 95% уверенностью мы можем сказать, что истинное значение hazard ratio для женщин по сравнению с мужчинами находится в этом интервале.

**Индекс конкордантности (C-индекс)** равен 0.579 и указывает на то, что модель имеет умеренную способность различать пациентов с разными рисками смерти. Значение 0.5 указывало бы на отсутствие различительной способности, а значение 1.0 — на идеальную различительную способность.

**Статистические тесты для оценки модели:** Likelihood ratio test, Wald test, и Score (logrank) test показывают статистическую значимость модели в целом. Все три теста дают p-значения меньше 0.05, что указывает на то, что **пол является значимым предиктором выживаемости** в данной модели.

В целом, результаты показывают, что пол имеет значимое влияние на выживаемость пациентов с раком легких, причем риск смерти для мужчин выше, чем у женщин в рамках данной модели.
